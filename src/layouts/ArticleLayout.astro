---
import ExternalLink from "$components/ExternalLink.astro";
import ContentHeader from "$components/shared/ContentHeader.astro";
import TableOfContent from "$components/shared/TableOfContent.astro";
import Tags from "$components/shared/Tags.astro";
import BaseLayout from "$layouts/BaseLayout.astro";
import { readableDate } from "$utils";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";

interface Props {
	article: CollectionEntry<"blog">;
}

const { article } = Astro.props;
const { Content, headings } = await render(article);

const hasSidenote = article.body?.includes("{% sidenote");
---

<BaseLayout title={article.data.title} description={article.data.tagline} removeAboutFromHeader>
	<header id="title" class="mb-6 mt-0 bg-accent-valencia text-white-sugar-cane">
		<div class:list={[hasSidenote ? "lg:ml-3/4 md:w-3/4 xl:w-auto" : "", "mx-4"]}>
			<div class="mx-auto w-centered-width py-8 sm:py-12">
				<h1 class="my-0 hyphens-auto text-5xl sm:hyphens-none sm:text-6xl">{article.data.title}</h1>
				{article.data.tagline && <h2 class="m-0 mt-4 text-xl">{article.data.tagline}</h2>}
				<div class="">
					{readableDate(article.data.date)}
					<Tags tags={article.data.tags} accentBackground />
				</div>
			</div>
		</div>
	</header>

	<section
		class:list={[
			hasSidenote ? "md:grid-cols-layout-tablet-sidenote" : "md:grid-cols-layout-tablet",
			"grid gap-x-4 lg:gap-x-0 xl:grid-cols-layout",
		]}
	>
		<aside
			class="hidden px-4 transition-opacity duration-100 ease-linear hover:opacity-100 xl:mr-0 xl:block"
		>
			{
				headings.length > 0 && (
					<TableOfContent headers={headings} maxDepth={article.data.maxDepthTOC ?? 4} />
				)
			}
		</aside>

		<article class="prose relative mx-auto w-centered-width px-4 xl:px-0">
			<ContentHeader item={article} includeTags includeTitle={false} />
			<Content components={{ a: ExternalLink }} />
		</article>
	</section>
</BaseLayout>

<script>
	const asides = document.querySelectorAll("aside");

	document.addEventListener(
		"scroll",
		() => {
			if (
				window.scrollY > 350 &&
				window.scrollY + window.innerHeight < document.body.scrollHeight - 250
			) {
				asides.forEach((aside, i) => {
					aside.classList.toggle(i === 0 ? "opacity-35" : "opacity-65", true);
				});
			} else {
				asides.forEach((aside, i) => {
					aside.classList.toggle(i === 0 ? "opacity-35" : "opacity-65", false);
				});
			}
		},
		{
			capture: false,
			passive: true,
		},
	);
</script>
